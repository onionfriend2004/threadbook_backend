## Здесь будет документация сервиса онлайн-статусов пользователей, гайc. 
## Но сначала правила заядлых javascript-изёров:

## Правило JS #0

### Очень сочувствую, если тебя сюда занесло бро. После `git pull` очень много ошибок? Напиши в консоль:

```bash
pnpm exec prettier --write src
```

И не меняй *LF* !

```json
"endOfLine": "lf"
```

Советую в файле `.vscode/settings.json` Вставить это:

```json
{
  "files.eol": "\n",
  "prettier.endOfLine": "lf"
}
```

И промтить в ИИшку чтобы везде *LF* был в контексте.

Не пуш скотина *CRLF*. Это может не собраться в линуксе.

## Правило JS #1

### Разворачивать проект вот так:

Локально (для разработки из папки `status-service`):

```bash
pnpm i
pnpm run dev
```

В контейнере на проде(из корня проекта):

```bash
docker compose up -d --build status
```

*P.S*: Не забудь конфиг, вот пример:

```yml
конфиг: ты_не_достоин_этого_конфига
```

# А теперь документация

Пред вами микросервис онлайн-статусов пользователей, написаных владыкой глубин GoVнокодинга\* на `TypeScript`.

Прошу его любить и жаловать на нашем проде и не пиздеть на `NestJS` ничего плохого (Лёшина фраза `щас бы на Go` тоже считается).
Используется `pnpm` менеджер пакетов, `Fastify` адаптер, `Prisma` ORM дабы летало, быстро собиралось и не выёбывалось.

## Сервис статусов юзеров юзает:

- `PostgreSQL` для хранения бизнес логики юзеров (Кастомки, Приватность, и прочее).
- Для хранения не персистентных данных (онлайнов) абузится `Redis` (online:user_id - 1 или нема).
- `Centrifugo` для real-time клиента. Вебхук как раз дёргает вот эта штука (как за яйца) и говорит отметь что этот чел онлайн а этот `съебался, чудище`.

## Эндпоинтов 6 как и хуёв в жопе Go-разработчиков:

Общий префикс `api/` (на версию похуй пока что, на тела запросов тоже=) гыгыгы)

- POST `user/status` - обновляет по факту статус юзера (по куки определяет `це хто?` и кладёт user_id со всей хуйнёй в Redis и PSQL). Возвращает 200 потому что JSON Стэтхам
- GET `user/status` - выдаёт статус юзера (аналогично `це хто?` и ищем в PSQL чё там по приватности, кастомности и прочему)
- GET `user/:username/status`} - выдаёт онлайн-статус типа по его нику (`це хто?` немного сложнее, но работает примерно так же. Всё как у Паши Дурова только ещё и дискорд ёпта)
- POST `user/status/batch` - мы чё долбаёбы по одному тягать статусы? Можем и batch сделать. Он как бы GET, но POST. Принимает список {":username"}[] и возвращает статусы этих сказочных долбаёбов тоже в списке (*identify - username*, `це хто?` ещё немного сложнее xD, но работает примерно так же)
- POST `webhooks/centrifugo/presence` - этот вебхук обрабатывает события от центрифуги connect/disconnect юзеров (по факту мы получаем инфу когда юзер подписан на WS, а когда отписан)
- PATCH `user/status/privacy` - переключает видимость статуса гаврика (`це хто?`, is_privacy = true | is_privacy = false)

---

\*Владыка глубин:

<img width="240" height="253" alt="image" src="https://github.com/user-attachments/assets/1c39e7d8-8f91-42fc-b1bb-10bddeefee11" />

